[gcode_macro POST_PRINT]
description: Clean up states, turn off heaters, set fan timeouts and park at rear
gcode:
    {% set unload = params.UNLOAD_AT_END|default(0)|int %}
    M117 Post Print
    STATUS_BUSY

    SAVE_GCODE_STATE NAME=STATE_POST_PRINT
    M107                                                ; Turn off PCF
    BED_MESH_CLEAR
    SET_FAN_SPEED FAN=nevermore SPEED=1
    SET_FAN_TIMEOUTS NEVERMORE=300 PCF=300 EXHAUST=600
    _PARK Z_HOP=20
    {% if unload | int == 1 %}
    ERCF_EJECT
    {% endif %}

    COOLDOWN_LEDS
    TURN_OFF_HEATERS
    RESTORE_GCODE_STATE NAME=STATE_POST_PRINT
    M84 ; Turn off steppers
