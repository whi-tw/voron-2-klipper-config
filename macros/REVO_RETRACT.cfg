[gcode_macro REVO_RETRACT]
variable_retracted_so_far: 0.0
gcode:
    {% set retract_distance = params.DISTANCE | default(22) | float %}
    SAVE_GCODE_STATE NAME=STATE_REVO_RETRACTION

    M83                               ; Relative extrusion
    G1 E-2 F2400                      ; Retract 2mm
    G1 E-{retract_distance - printer["gcode_macro REVO_RETRACT"].retracted_so_far | float - 2.0} F800  ; Retract so total retraction is `retract_distance`

    RESTORE_GCODE_STATE NAME=STATE_REVO_RETRACTION

    SET_GCODE_VARIABLE MACRO=REVO_RETRACT VARIABLE=retracted_so_far VALUE=0
    SAVE_VARIABLE VARIABLE=last_final_retraction VALUE={retract_distance}
