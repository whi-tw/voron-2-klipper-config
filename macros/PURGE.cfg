[gcode_macro PURGE]
gcode:
    {% set purge_position = (174, 300, 3.1) %}
    {% set move_speed = 300 %}

    {% set extrude_length = params.LENGTH | default(10) | float %}
    {% set extrude_speed = params.SPEED | default(5) | int %}

    SAVE_GCODE_STATE NAME=purge_state

    G90                                                                 ; Absolute positioning
    G0 X{purge_position[0]} Y{purge_position[1]} Z10 F{move_speed * 60} ; Move to purge bin
    G0 Z{purge_position[2]}                                             ; Plunge to Z height

    M83                                                                 ; Relative extrude distances

    G0 E{extrude_length} F{extrude_speed * 60}

    G0 Z10 F{move_speed * 60}                                           ; Lift away from bed

    RESTORE_GCODE_STATE NAME=purge_state
