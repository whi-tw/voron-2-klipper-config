[gcode_macro PRINT_START]
gcode:
    {% set bed_temp = params.BED | float %}
    {% set extruder_temp = params.EXTRUDER | float %}
    {% set chamber_temp = params.CHAMBER | float %}

    UPDATE_DELAYED_GCODE ID=turn_off_nevermore   DURATION=0
    UPDATE_DELAYED_GCODE ID=turn_off_exhaust_fan DURATION=0

    M117 Homing / QBL
    G32                                                                                    ; Home all axes
    M117 Heating up
    G90                                                                                    ; Absolute positioning
    G1 Z20 F3000                                                                           ; Move nozzle away from bed
    SET_HEATER_TEMPERATURE HEATER=extruder   TARGET={extruder_temp}                        ; Start heating extruder and continue
    SET_FAN_SPEED FAN=nevermore   SPEED=0.5
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={bed_temp}                             ; Start heating bed and continue
    TEMPERATURE_WAIT       SENSOR=extruder   MINIMUM={extruder_temp}                       ; Wait for extruder to reach target temperature
    M117 Waiting for temp
    TEMPERATURE_WAIT       SENSOR=heater_bed MINIMUM={bed_temp}                            ; Wait for bed to reach target temperature and continue
    G28 Z                                                                                  ; Re-home Z now nozzle is hot to avoid ooze causing bad homing.
    G0 X150 Y150 Z10 F3600                                                                 ; Place nozzle in center of bed
    SET_TEMPERATURE_FAN_TARGET temperature_fan=chamber target={chamber_temp} ; Set temperature fan target and min speed
    M117 Printing
