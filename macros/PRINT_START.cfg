[gcode_macro PRINT_START]
gcode:
    {% set bed_temp = params.BED | float %}
    {% set extruder_temp = params.EXTRUDER | float %}
    {% set chamber_temp = params.CHAMBER | float %}
    {% set initial_tool = params.INITIAL_TOOL | default(0) | int %}

    UPDATE_DELAYED_GCODE ID=turn_off_cooldown_leds DURATION=0
    STATUS_READY

    SET_FILAMENT_SENSOR SENSOR=encoder_sensor ENABLE=0

    RESET_FAN_TIMEOUTS

    _RESPOND P="PRINT_START" M="Homing X and Y" M117=1
    G28 X0 Y0
    G0 X200 Y200 F{300 * 60}
    G28

    _RESPOND P="PRINT_START" M="Parking while heating" M117=1
    STATUS_BUSY
    _PARK
    STATUS_READY

    _RESPOND P="PRINT_START" M="Heating Bed and Extruder" M117=1
    STATUS_HEATING
    SET_FAN_SPEED FAN=nevermore   SPEED=0.5
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={bed_temp}                             ; Start heating bed and continue
    SET_TEMPERATURE_FAN_TARGET temperature_fan=chamber target={chamber_temp}               ; Set temperature fan target and min speed
    TEMPERATURE_WAIT       SENSOR=heater_bed MINIMUM={bed_temp}                            ; Wait for bed to reach target temperature and continue
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={extruder_temp}
    TEMPERATURE_WAIT       SENSOR=extruder MINIMUM={extruder_temp}
    STATUS_READY

    _RESPOND P="PRINT_START" M="Cleaning Nozzle before probing" M117=1
    STATUS_CLEANING
    CLEAN_NOZZLE PURGE=0 RETURN=0
    M400
    STATUS_READY

    _RESPOND P="PRINT_START" M="Parking while cooling nozzle" M117=1
    STATUS_BUSY
    _PARK
    M400
    STATUS_READY

    _RESPOND P="PRINT_START" M="Cooling nozzle to 150C for probing"
    STATUS_COOLING
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET=150
    M106 S255 ; set PCF to max to speed up cooldown
    TEMPERATURE_WAIT       SENSOR=extruder MAXIMUM=150
    M106 S0 ; turn off PCF
    STATUS_READY

    _RESPOND P="PRINT_START" M="Homing Z with clean nozzle" M117=1
    STATUS_HOMING
    G28 Z
    M400
    STATUS_READY

    _RESPOND P="PRINT_START" M="Quad Ganty Level" M117=1
    STATUS_LEVELING
    QUAD_GANTRY_LEVEL
    M400
    STATUS_READY

    STATUS_HOMING
    G28 Z ; Ensure that Z understands the new world
    M400
    STATUS_READY

    _RESPOND P="PRINT_START" M="Bed Mesh Calibrate" M117=1
    STATUS_MESHING
    BED_MESH_CALIBRATE
    M400
    STATUS_READY

    _RESPOND P="PRINT_START" M="Parking to heat extruder and load filament" M117=1
    STATUS_BUSY
    _PARK
    M400
    STATUS_READY

    _RESPOND P="PRINT_START" M="Heating Extruder" M117=1
    STATUS_HEATING
    SET_HEATER_TEMPERATURE HEATER=extruder   TARGET={extruder_temp}                        ; Start heating extruder and continue
    TEMPERATURE_WAIT       SENSOR=extruder   MINIMUM={extruder_temp}                       ; Wait for extruder to reach target temperature
    STATUS_READY

    _RESPOND P="PRINT_START" M="Loading filament to the extruder" M117=1
    STATUS_LOADING
    {% set last_tool = printer.ercf.tool|default(-1)|int %}
    ERCF_CHANGE_TOOL_STANDALONE TOOL={initial_tool}
    {% set purge_length = 40 %}
    {% if last_tool == initial_tool %}
        {% set purge_length = 20 %}
    {% endif %}
    M400
    STATUS_READY

    _RESPOND P="PRINT_START" M="Cleaning Nozzle" M117=1
    STATUS_CLEANING
    CLEAN_NOZZLE PURGE=1 PURGE_LENGTH={purge_length} RETURN=0                               ; Purge then scrub nozzle
    M400
    STATUS_READY

    SET_FILAMENT_SENSOR SENSOR=encoder_sensor ENABLE=0
    G90                                                                                     ; Ensure we are in Absolute positioning

    _RESPOND P="PRINT_START" M="Printing" M117=1
    STATUS_PRINTING
