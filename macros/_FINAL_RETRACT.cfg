[gcode_macro _FINAL_RETRACT]
variable_retracted_so_far: 0.0
gcode:
    {% set retract_distance = params.DISTANCE | default(10) | float %}
    SAVE_GCODE_STATE NAME=STATE_FINAL_RETRACT

    M83                               ; Relative extrusion
    G1 E-2.0 F2400                    ; Retract 2mm
    G1 E-{retract_distance - printer["gcode_macro _FINAL_RETRACT"].retracted_so_far | float - 2.0} F800  ; Retract so total retraction is `retract_distance`

    RESTORE_GCODE_STATE NAME=STATE_FINAL_RETRACT

    SET_GCODE_VARIABLE MACRO=_FINAL_RETRACT VARIABLE=retracted_so_far VALUE=0
    SAVE_VARIABLE VARIABLE=last_final_retraction VALUE={retract_distance}
